name: Start Application on Server

on:
  push:
    branches:
      - master

jobs:
  deploy-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@13.60.63.159<< EOF

          export NVM_DIR="/home/ubuntu/.nvm"
          source "$NVM_DIR/nvm.sh"
          source "$NVM_DIR/bash_completion"

          node -v
          npm -v

          echo "*****Cloning or updating repository"
          if [ -d "ByteBrain_Backend" ]; then
            cd ByteBrain_Backend
            git pull origin master
          else
            git clone https://github.com/doomerdpk-1802/ByteBrain_Backend.git
            cd ByteBrain_Backend
          fi

          echo "DATABASE_URL=${DATABASE_URL}" > .env
          echo "JWT_SECRET=${JWT_SECRET}" >> .env

          echo "*****Installing dependencies"
          npm install --legacy-peer-deps
          npm i pm2
          npm i typescript
          npx tsc -b
          npx pm2 stop bytebrain || true
          npx pm2 start dist/index.js --name bytebrain

          echo "*****Updating NGINX configuration"
          sudo cp ./nginx.conf /etc/nginx/nginx.conf
          sudo nginx -t
          sudo systemctl reload nginx

          echo "*****Setting up SSL (Certbot)"
          if ! command -v certbot >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y certbot python3-certbot-nginx
          fi

          sudo certbot --nginx -d "learnsphere-vercel.api.deepak.cfd" --non-interactive --agree-tos --register-unsafely-without-email
          sudo certbot --nginx -d "bytebrain.api.deepak.cfd" --non-interactive --agree-tos --register-unsafely-without-email

          echo "âœ… Deployment complete!"
          EOF
