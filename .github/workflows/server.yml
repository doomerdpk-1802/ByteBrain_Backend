name: Start Application on Server

on:
  push:
    branches:
      - master

jobs:
  deploy-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@13.49.73.62 << EOF
          set -e

          echo "ðŸ”¹ Loading Node environment"
          export NVM_DIR="\$HOME/.nvm"
          [ -s "\$NVM_DIR/nvm.sh" ] && . "\$NVM_DIR/nvm.sh"
          [ -s "\$NVM_DIR/bash_completion" ] && . "\$NVM_DIR/bash_completion"
          export PATH="\$NVM_DIR/versions/node/\$(nvm version)/bin:\$PATH"

          echo "ðŸ”¹ Cloning or updating repository"
          if [ -d "ByteBrain_Backend" ]; then
            cd ByteBrain_Backend
            git pull origin master
          else
            git clone https://github.com/doomerdpk-1802/ByteBrain_Backend.git
            cd ByteBrain_Backend
          fi

          echo "ðŸ”¹ Writing .env file"
          echo "DATABASE_URL=${DATABASE_URL}" > .env
          echo "JWT_SECRET=${JWT_SECRET}" >> .env
          cat .env | sed 's/=.*/=*****/'  

          echo "ðŸ”¹ Installing dependencies"
          npm install --legacy-peer-deps

          echo "ðŸ”¹ Starting app with PM2"
          if ! command -v pm2 >/dev/null 2>&1; then
            npm install -g pm2
          fi

          pm2 stop all || true
          pm2 start dist/index.js --name bytebrain
          pm2 logs bytebrain --lines 30

          echo "ðŸ”¹ Updating NGINX config"
          sudo cp ./nginx.conf /etc/nginx/nginx.conf
          sudo nginx -t
          sudo systemctl reload nginx

          echo "ðŸ”¹ Setting up SSL (Certbot)"
          if ! command -v certbot >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y certbot python3-certbot-nginx
          fi

          sudo certbot --nginx -d "bytebrain.api.deepak.cfd" --non-interactive --agree-tos --register-unsafely-without-email

          echo "âœ… Deployment complete!"
          EOF
