name: Start Application on Server

on:
  push:
    branches:
      - master

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@16.171.52.44 << EOF

          export NVM_DIR="\$HOME/.nvm"
          [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
          [ -s "\$NVM_DIR/bash_completion" ] && \. "\$NVM_DIR/bash_completion"
          export PATH="\$NVM_DIR/versions/node/v22.20.0/bin:\$PATH"

          if [ -d "ByteBrain_Backend" ]; then
            cd ByteBrain_Backend
            git pull origin master
          else
            git clone https://github.com/doomerdpk-1802/ByteBrain_Backend.git
            cd ByteBrain_Backend
          fi

          npm install

          cat > .env <<EOL
          DATABASE_URL=${DATABASE_URL}
          JWT_SECRET=${JWT_SECRET}
          EOL

          command -v pm2 >/dev/null 2>&1 || npm install -g pm2

          npm run stop:pm2 || true
          npm run start:pm2

          cd /home/ubuntu/ByteBrain_Backend
          sudo cp ./nginx.conf /etc/nginx/nginx.conf
          sudo nginx -t && sudo systemctl reload nginx

          if ! command -v certbot >/dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y certbot python3-certbot-nginx
          fi

          sudo certbot --nginx -d "bytebrain.api.deepak.cfd" --non-interactive --agree-tos --register-unsafely-without-email

          EOF
